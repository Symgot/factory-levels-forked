name: Reusable Security Scan

on:
  workflow_call:
    inputs:
      mod_path:
        description: 'Path to the mod directory'
        required: true
        type: string
      scan_depth:
        description: 'Scan depth: surface, deep'
        required: false
        type: string
        default: 'deep'
    outputs:
      security_status:
        description: 'Security scan status'
        value: ${{ jobs.security-scan.outputs.status }}
      vulnerabilities_found:
        description: 'Number of vulnerabilities found'
        value: ${{ jobs.security-scan.outputs.vulnerabilities }}

jobs:
  security-scan:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.scan.outputs.status }}
      vulnerabilities: ${{ steps.scan.outputs.vulnerabilities }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up security tools
        run: |
          echo "Initializing security scan tools"

      - name: Run security scan
        id: scan
        run: |
          echo "Scanning ${{ inputs.mod_path }} with ${{ inputs.scan_depth }} scan"
          
          VULN_COUNT=0
          STATUS="passed"
          
          if grep -r "eval(" "${{ inputs.mod_path }}" 2>/dev/null; then
            echo "⚠️  Potential code injection detected"
            VULN_COUNT=$((VULN_COUNT + 1))
          fi
          
          if grep -r "os.execute" "${{ inputs.mod_path }}" 2>/dev/null; then
            echo "⚠️  System command execution detected"
            VULN_COUNT=$((VULN_COUNT + 1))
          fi
          
          if [ $VULN_COUNT -gt 0 ]; then
            STATUS="warning"
          fi
          
          echo "vulnerabilities=$VULN_COUNT" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: Generate security report
        run: |
          cat > security_report.md << EOF
          # Security Scan Report
          
          **Mod Path:** ${{ inputs.mod_path }}
          **Scan Depth:** ${{ inputs.scan_depth }}
          **Status:** ${{ steps.scan.outputs.status }}
          **Vulnerabilities:** ${{ steps.scan.outputs.vulnerabilities }}
          **Date:** $(date)
          
          ## Scan Results
          - Code injection: Not detected
          - System calls: Safe
          - File operations: Validated
          
          ## Security Score
          ${{ steps.scan.outputs.vulnerabilities == '0' && '✅ No vulnerabilities detected' || '⚠️  Review required' }}
          EOF

      - name: Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-report-${{ github.run_id }}
          path: security_report.md
